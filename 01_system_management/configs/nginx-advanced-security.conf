# Advanced Security Configuration for nginx
# File: /etc/nginx/snippets/advanced-security.conf

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=5r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;
limit_conn addr 10;

# Request size limits
client_max_body_size 1M;
client_header_buffer_size 1k;
large_client_header_buffers 2 1k;

# Timeout configurations
client_body_timeout 10s;
client_header_timeout 10s;
send_timeout 10s;
keepalive_timeout 30s;

# Buffer overflow protection
client_body_buffer_size 1K;
client_header_buffer_size 1k;

# Hide nginx version and server information
server_tokens off;
more_set_headers 'Server: SecureServer';

# Disable unwanted HTTP methods
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
    return 405;
}

# Block common attack patterns
location ~* /(wp-admin|wp-login|phpmyadmin|admin|administrator|login) {
    deny all;
    return 403;
}

# Block suspicious User-Agents
if ($http_user_agent ~* (curl|wget|python|go-http|libwww|urllib|nikto|sqlmap|nmap)) {
    return 403;
}

# Block empty User-Agent
if ($http_user_agent = "") {
    return 403;
}

# Prevent access to sensitive files
location ~* \.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|backup|old|tmp)$ {
    deny all;
    return 403;
}

# Prevent access to version control directories
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    return 403;
}

# Security for API endpoints
location /api/ {
    # Apply rate limiting
    limit_req zone=api burst=20 nodelay;
    
    # API-specific security headers
    add_header X-API-Rate-Limit "10 requests per second" always;
    add_header X-API-Documentation "https://192.168.111.200/docs" always;
    
    # JSON-only content type for API
    if ($content_type !~ "application/json") {
        add_header Content-Type "application/json" always;
    }
}

# Security for admin areas
location /admin/ {
    # Strict rate limiting for admin
    limit_req zone=login burst=5 nodelay;
    
    # Additional security headers
    add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive" always;
    add_header X-Admin-Security "Enhanced" always;
    
    # IP whitelist (configure as needed)
    # allow 192.168.1.0/24;
    # allow 10.0.0.0/8;
    # deny all;
}

# DDoS protection
location / {
    limit_req zone=general burst=10 nodelay;
    limit_conn addr 5;
}

# Block common exploit attempts
location ~* \.(php|asp|aspx|jsp|cgi)$ {
    return 403;
}

# Prevent hotlinking
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    valid_referers none blocked server_names ~\.google\. ~\.bing\. ~\.yahoo\. ~\.duckduckgo\.;
    if ($invalid_referer) {
        return 403;
    }
}
